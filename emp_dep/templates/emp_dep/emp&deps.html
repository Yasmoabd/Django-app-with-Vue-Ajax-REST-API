{% extends 'emp_dep/base.html' %}

{% block content %}
    <div id="app">
        <h1>Employees</h1>
        <form id="addEmpForm">
            <label for="fname">Name:</label><br>
            <input type="text" id="fname" name="fname"><br>
            <label for="age">Age:</label><br>
            <input type="text" id="age" name="age">
            <select id="depdrop" name="depdrop" id="depdrop" multiple>
                <option v-for="(department) in departments" v-bind:value="department.id">[[ department.name ]]</option>
            </select>
            <button type="button" v-on:click="showselected()">show selected</button>
            
          </form>
          <button type="button" form="addEmpForm" value="Submit" v-on:click="addEmployee">Submit</button>

        {% csrf_token %}
        

        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Join Date</th>
                    <th scope="col">Age</th>
                    <th scope="col">Departments</th>
                    <th width="100" scope="col">hello</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(employee, index) in employees">
                    <th scope="row">
                        [[ index ]]
                    </th>
                    <td>
                            [[ employee.name ]]          
                    </td>
                    <td>[[ employee.join_date ]]</td>
                    <td>[[ employee.age ]]</td>
                    <td>[[ employee.departments ]]</td>
                    <td>
                        <button @click="deleteEmployee(employee)" class="btn btn-sm btn-danger">
                            Delete
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <!-- second table -->

        <h1>Departments</h1>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Salary</th>
                    <th scope="col">Employees</th>
                    <th width="100" scope="col"></th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(department, index) in departments">
                    <th scope="row">
                        [[ index ]]
                    </th>
                    <td>
                            [[ department.name ]]          
                    </td>
                    <td>[[ department.salary ]]</td>
                    <td>[[ department.employees ]]</td>
                    <td>
                        Nothing for now
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let myApp = Vue.createApp({
        delimiters: ["[[", "]]"],
        data() {
            return {
                employees: [],
                departments: []
            }
        },
        async created() {
            let response = await fetch("{% url 'employees api' %}");
            if (response.ok) {
                let data = await response.json();
                this.employees = data.employees;
            }
            else {
                alert("Failed to load list of employees");
            }
            let response2 = await fetch("{% url 'departments api' %}");
            if (response2.ok) {
                let data = await response2.json();
                this.departments = data.departments;
            }
            else {
                alert("Failed to load list of departments");
            }
        },
        methods: {
            async addEmployee(){
                var nameValue = document.getElementById("fname").value;
                var ageValue = document.getElementById("age").value;
                
                var selected = [];
                for (var option of document.getElementById('depdrop').options)
                {  
                    if (option.selected) {
                    selected.push(option.value);
                    }
                }

                var obj = {name: nameValue, age: ageValue, departments: selected};
                let response = await fetch("{% url 'employees api'%}",{method:"POST", body: JSON.stringify(obj),
                headers: {
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken").value,
                        }});
                if (response.ok) {
                    let response2 = await fetch("{% url 'employees api' %}");
                    if (response2.ok) {
                        let data = await response2.json();
                        this.employees = data.employees;
                    }
                    else{
                        alert("Failed to load employees");
                    }
                }
                else{
                    alert("Failed to add employee");
                }
            },

            async deleteEmployee(employee) {
                // add ajax request to delete that country
                if (confirm(`Are you sure you want to delete ${employee.name}?`)) {
                    let response = await fetch(employee.api, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken").value,
                        }
                    });
                    if (response.ok) {
                        // country was deleted OK!
                        this.employees = this.employees.filter(e => e.id != employee.id);
                    }
                    else {
                        alert("Failed to delete country");
                    }
                }
            },

            showselected(){
                var selected = [];
                for (var option of document.getElementById('depdrop').options)
                {  
                    if (option.selected) {
                    selected.push(option.value);
                    }
                }
                console.log(selected);
            }
        }
    })
    
    myApp.mount('#app')
</script>
{% endblock %}